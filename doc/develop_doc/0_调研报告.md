/* competition preparation and survey is the pre-stage of whole development*/

# 1.基本概念介绍

## 1.1 eBPF技术

### 1.1.1 libbpf

### 1.1.2 bcc

## 1.2 docker原理：容器与进程

### 1.2.1 Namespace

### 1.2.2 Cgroup

#### Cgroup介绍

CGroup 是 Control Groups 的缩写，是 Linux 内核提供的一种可以限制、记录、隔离进程组 (process groups) 所使用的物力资源 (如 cpu memory i/o 等等) 的机制。2007 年进入 Linux 2.6.24 内核，CGroups 不是全新创造的，它将进程管理从 cpuset 中剥离出来，作者是 Google 的 Paul Menage。CGroups 也是 LXC 为实现虚拟化所使用的资源管理手段。

#### CGroup 功能及组成

CGroup 是将任意进程进行分组化管理的 Linux 内核功能。CGroup 本身是提供将进程进行分组化管理的功能和接口的基础结构，I/O 或内存的分配控制等具体的资源管理功能是通过这个功能来实现的。这些具体的资源管理功能称为 CGroup 子系统或控制器。CGroup 子系统有控制内存的 Memory 控制器、控制进程调度的 CPU 控制器等。运行中的内核可以使用的 Cgroup 子系统由/proc/cgroup 来确认。

CGroup 提供了一个 CGroup 虚拟文件系统，作为进行分组管理和各子系统设置的用户接口。要使用 CGroup，必须挂载 CGroup 文件系统。这时通过挂载选项指定使用哪个子系统。

cgroups task_struct reference:

https://www.infoq.cn/article/docker-kernel-knowledge-cgroups-resource-isolation/

https://blog.csdn.net/punk_lover/article/details/78376430

> cgroup 指针指向了一个 cgroup 结构，也就是进程属于的 cgroup。进程受到子系统的控制，实际上是通过加入到特定的 cgroup 实现的，因为 cgroup 在特定的层级上，而子系统又是附和到上面的。通过以上三个结构，进程就可以和 cgroup 连接起来了：task_struct->css_set->cgroup_subsys_state->cgroup。

```c
static void fill_container_id(char *container_id) {
  struct task_struct *curr_task;
  struct css_set *css;
  struct cgroup_subsys_state *sbs;
  struct cgroup *cg;
  struct kernfs_node *knode, *pknode;
 
  curr_task = (struct task_struct *) bpf_get_current_task();
  css = curr_task->cgroups;
  bpf_probe_read(&sbs, sizeof(void *), &css->subsys[0]);
  bpf_probe_read(&cg,  sizeof(void *), &sbs->cgroup);
 
  bpf_probe_read(&knode, sizeof(void *), &cg->kn);
  bpf_probe_read(&pknode, sizeof(void *), &knode->parent);
 
  if(pknode != NULL) {
    char *aus;
 
    bpf_probe_read(&aus, sizeof(void *), &knode->name);
    bpf_probe_read_str(container_id, CONTAINER_ID_LEN, aus);
  }
}
```

# 参考资料

## ebpf

1. 基于 eBPF 实现容器运行时安全

   https://mp.weixin.qq.com/s/UiR8rjTt2SgJo5zs8n5Sqg
2. 基于ebpf统计docker容器网络流量

   https://blog.csdn.net/qq_32740107/article/details/110224623
3. BumbleBee: Build, Ship, Run eBPF tools

   https://www.solo.io/blog/solo-announces-bumblebee/
4. Container traffic visibility library based on eBPF

   https://github.com/ntop/libebpfflow
5. about libbpf

   https://nakryiko.com/posts/libbpf-bootstrap/#why-libbpf-bootstrap
   https://nakryiko.com/posts/bpf-core-reference-guide/
6. bcc to libbpf

   https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/#setting-up-user-space-parts
7. good intro for trace point and kprobe in ebpf

   https://www.iserica.com/posts/brief-intro-for-tracepoint/
   https://www.iserica.com/posts/brief-intro-for-kprobe/
8. other

   https://lockc-project.github.io/book/index.html
   https://github.com/willfindlay/bpfcontain-rs
9. user space uprobe

   https://www.collabora.com/news-and-blog/blog/2019/05/14/an-ebpf-overview-part-5-tracing-user-processes/
10. ebpf secomp

    https://developers.redhat.com/articles/2021/12/16/secure-your-kubernetes-deployments-ebpf#how_does_the_bpf_recorder_work_

    https://github.com/kubernetes-sigs/security-profiles-operator/blob/main/internal/pkg/daemon/bpfrecorder/bpf/recorder.bpf.c
11. tools

    https://github.com/iovisor/bcc/tree/master/libbpf-tools
