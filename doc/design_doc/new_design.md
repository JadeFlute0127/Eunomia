# 决赛设计

Eunomia目前应当属于是采集器级别，目标是与其他开源组件完成适配工作，提供一套完整的云原生监控。目前存在以下不足：

- 从数据源来说，缺少日志能力、调用链跟踪能力；也无法和其他功能组件更好的集成
- 从功能来说，安全引擎不完善；采集功能可扩展性差，安全引擎、分析功能、exporter 和 collector 强绑定；二进制文件较大；
- 从整体架构来说，数据存储方案不完备：本地持久化？远端存储？；和 prometheus 的交互方式比较单一；

观测平台的四个层次来讲，我们要做的应该是解决方案，在保证核心功能可用的基础上，尽可能多的复用开源组件搭建一套完整的系统；

## 解决方案和需要改进的部分

> 草稿和个人理解

### collector 方面：和 analysis/exporter 解耦

在原有的 cpp/c 混合的采集器基础上：

- 去除 prometheus 的 exporter，保留命令行和一些简单的事件预处理和发布机制，以及 ebpf 的装载机制
- 通过 HTTP/gRPC/其他机制，collector 进行指标上报和数据采集，发送给 analysis core，进行进一步的分析和处理，也可以让 core 去向 collector 进行初步的 query 来拉取数据；
- core 使用 go 编写，负责复杂的处理逻辑，和 prometheus/opentelemetry 信息上报；负责安全引擎的分析；同时可以控制 collector 的调度运行；

### 具体功能（可能）

目前已经有的

- 对于多种事件的简单监控（syscall，tcp，process，files）
- 对于容器的简单监控能力（实际上很不全面）

接下来最好要做的事情：

- 事件的指标聚合，比如说把事件聚合成为 Sum、Count、Last value、Histograms 这样的指标（这个部分可以在 cpp 的层面做一部分，这样可以极大地减轻系统的overload），然后上报给 go 客户端；
- 容器监控的完善；这部分需要进一步调研，添加新的 tracepoint（比如 cgroup 相关的）？或者只考虑 k8s 的环境，使用 k8s 的 API？或者集成其他的k8s监控程序？这部分应该在 go 里面完成；
- 安全的部分，我觉得应该是让用户自行添加安全规则，在 go core analysis 里面完成；
- 需要安全告警，这部分使用开源的组件搭建；

创新点（可以做的部分）：

- 我们目前做的大部分都是系统层面的事件采集，如文件 IO，tcp 连接，进程，syscall 等等；可以再添加一些其他的有价值的指标，这需要对事件进行聚合；需要我们能快速地添加新的开源工具的组件（libbpf-tools）；
- 在容器层面，pod 调用拓扑？k8s 的其他指标分析？最好能复用开源组件；
  - 比如我记得 grafana 好像已经有展示调用拓扑的插件？
- 具体应用层面，提供一键生成火焰图的功能？（这是我在做的事情）
- 提供微服务全链路追踪能力？这部分我不确定做起来难不难，如果很难但是有现成的开源产品的话不如直接拿来用；

### 使用 Opentelemetry 实现可观测性的标准

考虑搭建一套在集群上的完整系统，验证可用性？

- k8s 集群环境；
- Opentelemetry 协议规范和集成；

还可以

- kafka 之类的消息队列，用于分布式的事件消息传递；
- 数据存储持久化；

这些应该尽量通过开源组件的配置完成，我们只需要关注核心功能的实现；

类似调研里面 kinding，skywalking 和端点科技的图

### 实际测试

- 最好能在一个真实的分布式集群上跑起来测试
- 找个简单的微服务系统？

## ebpf collector 设计

- tcpconnect 和 syscall 可能不能每次都上报，需要改成定期查询（类似 files）那种；（现在 eunomia 开了 syscall 之后，会有很大以上的性能损失....这显然是不符合监控的要求的）
- 除了那些主要的、高频的 ebpf hook，其他可以直接使用 libbpf-tools 里面的二进制，通过命令执行的方式启动，然后通过文件（或者管道）传递返回值？需要高频传递数据或者必须开启的主要追踪器就通过编译整合进来
- graphql 意义不大，用什么 API 不重要，只要传递信息高效就好；

collector 除了 RPC 或者 http 上报数据到 core 之外，就只有简单的启动停止、遍历 ebpf map 进行数据聚合（固定时间计数等等简单功能） ，还有输出到命令行的功能；

一个 core 对应一个或者多个 collector/agent，可以实现不同的功能，在同一台机器上面（也可以只有一个）；分布式的消息传递、数据存储落盘、可视化等等的就由后面的 Opentelemetry 加上 MQ、DB、prometheus、grafana 等等别的东西实现；