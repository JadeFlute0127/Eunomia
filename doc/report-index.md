# 操作系统大赛：基于 eBPF 的容器监控工具 Eunomia 决赛报告目录

> 本文档为决赛报告的目录，包含了主要的设计思路和创新点展示，以及一些比赛的相关信息。细节实现部分请参考每个部分列举的附加文档。

<!-- TOC -->

- [项目目标](#项目目标)
- [项目测试](#项目测试)
- [开发计划](#开发计划)
  - [日程表](#日程表)
  - [未来的工作方向](#未来的工作方向)
- [比赛过程中的重要进展](#比赛过程中的重要进展)
- [分工协作](#分工协作)
  - [初赛阶段](#初赛阶段)
  - [决赛阶段](#决赛阶段)
- [比赛收获](#比赛收获)
  - [郑昱笙同学](#郑昱笙同学)
  - [张典典同学](#张典典同学)
  - [濮雯旭同学](#濮雯旭同学)
- [Contact](#contact)

<!-- /TOC -->
## 项目目标

`Eunomia` 是一个使用 C/C++ 开发的基于 eBPF的轻量级，高性能云原生监控工具框架，旨在帮助用户了解容器的各项行为、监控可疑的容器安全事件，力求提供覆盖容器全生命周期的轻量级开源监控解决方案。

它使用 `Linux` `eBPF` 技术在运行时跟踪您的系统和应用程序，并分析收集的事件以检测可疑的行为模式。目前，它包含性能分析、容器集群网络可视化分析*、容器安全感知告警、一键部署、持久化存储监控等功能，提供了多样化的 ebpf 追踪点，并可以轻松拓展。其核心导出器/命令行工具最小仅需要约 4MB 大小的二进制程序，即可在支持的 Linux 内核上启动。

* [X] 开箱即用：以单一二进制文件或镜像方式分发，一次编译，到处运行，一行代码即可启动，包含多种 ebpf 工具和多种监测点，支持多种输出格式（json, csv, etc) 并保存到文件；
* [X] 轻量级，高性能：编译成的二进制大小仅 `4MB`;
* [X] 通过 `ebpf` 自动收集容器和 k8s 相关元信息，并和多种指标相结合；
* [X] 可集成 `prometheus` 和 `Grafana`，作为监控可视化和预警平台；也可作为 `OpenTelemetry` 的 collector 使用；
* [X] 可自定义运行时安全预警规则, 并通过 prometheus 等实现监控告警;
* [X] 可以自动收集进程行为并通过 `seccomp`/`capability` 进行限制；
* [X] 提供远程的 http API 进行控制，实现 ebpf 跟踪器的热插拔、一键分发和热更新，也可自行定制插件进行数据分析;
* [X] 其核心框架高度可扩展，可以非常轻松地集成其他的 libbpf ebpf C 程序； 

## 项目测试

请参考：[test.md](test.md)

## 开发计划

### 日程表

阶段一：学习ebpf相关技术栈（3.10~4.2）

* [X] 入门ebpf技术栈
* [X] 调研、学习 `bcc`
* [X] 调研、学习 `libbpf` 、`libbpf-bootstrap`
* [X] 调研、学习 `seccomp`
* [X] 输出调研文档

阶段二：项目设计（4.3~4.10）

* [X] 与mentor讨论项目需求、并设计功能模块
* [X] 输出系统设计文档
* [X] 输出模块设计文档

阶段三：开发迭代（4.10~6.1）

* [X] 实现进程信息监控（pid、ppid等）
* [X] 实现系统调用信息监控
* [X] 实现进程间通信监控
* [X] 实现tcp（ipv4、ipv6）通信监控
* [X] 实现监控信息存储功能（csv或json格式）
* [X] 完成了系统的原型验证功能
* [X] 基于上述功能，实现命令行调用，完成版本v0.1
* [X] 输出开发v0.1日志文档
* [X] 实现进程id与容器id映射，进程信息过滤
* [X] 添加“seccomp”功能
* [x] 基于上述新增功能，迭代版本v0.2
* [X] 输出开发v0.2日志文档
* [x] 添加可视化模块: prometheus and grafana
* [X] add more tools from libbpf-tools
* [X] 基于上述新增功能，迭代版本v0.3
* [X] 输出开发v0.3日志文档
* [X] 后续更新迭代

阶段四：开发测试（6.2~6.16）

* [X] add more rules
* [X] 设计测试场景（分别针对基础功能、权限控制、安全逃逸场景）
* [X] 搭建测试环境
* [X] 测试-开发
* [X] 输出测试文档

阶段五：项目文档完善（6.17~7.1）

* [X] 完善开发文档
* [X] 完善教程文档
* [X] 完善labs

阶段六：项目重构与探索（7.2~8.1）
阶段七：接入新的追踪器，实现 ebpf 的热分发与热更新
阶段八：项目运行与测试（8.2~8.16）

### 未来的工作方向

在未来我们计划继续按照上述日程表，完成我们未完成的工作，同时不断优化代码，使得Eunomia能成为一个具有较大使用价值的工具。主要有如下几个方向：

- 完善单元测试和测试场景，并且提供更完整的 benchmark；
- 完善教程文档；
- 完善安全规则和安全分析告警模块，这一部分目前只是个雏形；
- 添加更多的 ebpf 探针，并且支持自定义探针；
- 完善 http 在线分析模块；
- 更进一步地完善 ebpf 热分发和热更新模块;
....

## 比赛过程中的重要进展

- 2022.5.1 首段代码push，实现了对系统调用的成功追踪
- 2022.5.15 完成了五大追踪模块的ebpf代码和简易用户态代码
- 2022.5.17 重构用户态代码，引入简易命令行控制
- 2020.5.20 正式定名Eunomia，该名字的原意是古希腊神话中的一位司管明智，法律与良好秩序女神。我们希望本工具也能在容器安全检测和可观测性中发挥到这样的作用。
- 2022.5.22 将CMake引入本工程，提高了项目编译的速度
- 2022.5.23 开始集成 Prometheus 模块进入工程
- 2022.5.24 重构用户态代码，基本确定命令行控制形式
- 2022.5.28 将日志记录工具spdlog引入本工程
- 2022.6.1 prometheus 和 Grafana 模块集成完成，设计相关 dashboard
- 2022.6.3 完成了 sec_analyzer 模块，对安全风险事件进行分析,发布第一个版本V0.05
- 2022.6.4 整理初赛文档；
- 2022.8.1 添加静态分析和运行时分析，保证安全性与可用性
- 2022.8.7 发布第一个大版本V0.2
- 2022.8.8 接入一系列新的trakcer
- 2022.8.9 发布版本V0.25
- 2022.8.14 整理决赛报告，完善文档

## 分工协作

现在我们大部分的分工方式是在 gitlab 上面的 issue 中进行分配，并且且通过 issue 完成项目质量管理和追踪。参考：[issues](https://gitlab.eduxiji.net/zhangdiandian/project788067-89436/-/issues)

### 初赛阶段

- 郑昱笙同学：负责项目架构设计和调研，负责了 process、files、syscall 相关探针设计；
- 张典典同学：主要负责了seccomp模块、可视化以及部分quickstart的工作
- 濮雯旭同学：主要负责了container和ipc追踪模块的撰写以及后期用户态代码中与命令行控制相关的重构工作

### 决赛阶段

- 郑昱笙同学：负责项目重构、框架设计、跟踪器设计和 ebpf 热更新、热分发；
- 张典典同学：主要负责接入新的 tracker 和可视化部分；
- 濮雯旭同学：主要负责文档和教程的撰写；


## 比赛收获

### 郑昱笙同学

收获：

- 第一次大规模实践了现代 C++（cpp20） 的代码风格和开发模式，深入学习了相关语言知识和 cmake 编译工具链，以及代码持续集成、持续分析等知识；
- 对 ebpf 和操作系统相关概念有了深入的了解
- 对于云原生容器监控相关技术栈有一个深入的实践；

### 张典典同学

此次比赛让我了解到了ebpf技术，借此机会对操作系统内核中进程相关的数据结构例如struct task、thread_info、regs等有了深入的了解，对于Linux的seccomp安全机制、cgroup机制有了充分的认识，亲手体验了使用内核监控的开发，通过应用Grafana等可视化组件，提升了我对时序数据的存储、操作、展示的理解。

### 濮雯旭同学

此次比赛让我了解到了什么是ebpf技术，也亲手体验了一下如何使用ebpf技术开发内核监控程序，增强了我的工程能力。这对于立志从事操作系统相关工作的我来说具有重要的意义。与此同时，我还了解到了Prometheus，Graphna等众多新技术，也增长了我的视野。


## Contact

**成员**

指导老师：程泽睿志（华为）李东昂（浙江大学）

学生：郑昱笙（yunwei37: 1067852565@qq.com），濮雯旭，张典典
