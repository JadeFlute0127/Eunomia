# 项目设计报告: Eunomia

基于 eBPF 的轻量级 CloudNative Monitor 工具，用于容器安全性和可观察性

## 1. 目录

<!-- TOC -->

- [项目设计报告: Eunomia](#项目设计报告-eunomia)
  - [1. 目录](#1-目录)
  - [2. 目标描述](#2-目标描述)
    - [2.1. 功能概述](#21-功能概述)
    - [2.2. Tutorial](#22-tutorial)
  - [3. 比赛题目分析和相关资料调研](#3-比赛题目分析和相关资料调研)
    - [3.1. 题目描述](#31-题目描述)
    - [3.2. 赛题分析](#32-赛题分析)
    - [3.3. 相关资料调研](#33-相关资料调研)
      - [3.3.1. ebpf](#331-ebpf)
      - [3.3.2. ebpf 开发工具技术选型](#332-ebpf-开发工具技术选型)
      - [3.3.3. 容器可观测性](#333-容器可观测性)
      - [3.3.4. 信息可视化展示](#334-信息可视化展示)
      - [3.3.5. 容器运行时安全](#335-容器运行时安全)
  - [4. 系统框架设计](#4-系统框架设计)
    - [4.1. 系统设计](#41-系统设计)
    - [4.2. 模块设计](#42-模块设计)
    - [4.3. 功能设计](#43-功能设计)
    - [4.4. ebpf 主要观测点](#44-ebpf-主要观测点)
    - [4.5. ebpf 可观测信息设计](#45-ebpf-可观测信息设计)
    - [4.6. 重要数据结构设计](#46-重要数据结构设计)
    - [4.7. 安全规则设计](#47-安全规则设计)
  - [5. 开发计划](#5-开发计划)
  - [6. 比赛过程中的重要进展](#6-比赛过程中的重要进展)
  - [7. 系统测试情况](#7-系统测试情况)
    - [7.1. 命令行测试情况](#71-命令行测试情况)
    - [7.2. 容器测试情况](#72-容器测试情况)
    - [7.3. 信息可视化测试情况： prometheus and grafana](#73-信息可视化测试情况-prometheus-and-grafana)
    - [7.4. CI/持续集成](#74-ci持续集成)
  - [8. 遇到的主要问题和解决方法](#8-遇到的主要问题和解决方法)
    - [8.1. 如何设计 ebpf 挂载点](#81-如何设计-ebpf-挂载点)
    - [8.2. 如何进行内核态数据过滤和数据综合](#82-如何进行内核态数据过滤和数据综合)
    - [8.3. 如何定位容器元信息](#83-如何定位容器元信息)
    - [8.4. 如何设计支持可扩展性的数据结构](#84-如何设计支持可扩展性的数据结构)
  - [9. 分工和协作](#9-分工和协作)
  - [10. 提交仓库目录和文件描述](#10-提交仓库目录和文件描述)
    - [10.1. 项目仓库](#101-项目仓库)
    - [10.2. 文件描述](#102-文件描述)
  - [11. 比赛收获](#11-比赛收获)
  - [12. 附录](#12-附录)
    - [12.1. Prometheus 观测指标](#121-prometheus-观测指标)
    - [12.2. 命令行工具帮助信息](#122-命令行工具帮助信息)

<!-- /TOC -->

## 2. 目标描述

本项目由两部分组成：

* 一个零基础入门 `eBPF` 技术的教程实践和对应的命令行工具集，主要使用 `C/C++` 语言开发, 同时作为原型验证;
* 一个基于 `eBPF` 技术实现的用于监控容器的工具(**Eunomia**), 包含 `profile`、容器集群网络可视化分析、容器安全感知告警、一键部署、持久化存储监控等功能, 主要使用 Go 语言开发, 力求为工业界提供覆盖容器全生命周期的轻量级开源监控解决方案;

### 2.1. 功能概述

`Eunomia` 是一个使用 C/C++ 开发的基于eBPF的云原生监控工具，旨在帮助用户了解容器的各项行为、监控可疑的容器安全事件，力求为工业界提供覆盖容器全生命周期的轻量级开源监控解决方案。它使用 `Linux` `eBPF` 技术在运行时跟踪您的系统和应用程序，并分析收集的事件以检测可疑的行为模式。目前，它包含 `profile`、容器集群网络可视化分析*、容器安全感知告警、一键部署、持久化存储监控等功能。

* [X] 开箱即用：以单一二进制文件或 `docker` 镜像方式分发，一次编译，到处运行，一行代码即可启动，包含多种 ebpf 工具和多种监测点，支持多种输出格式（json, csv, etc) 并保存到文件；
* [X] 通过 `ebpf` 自动收集容器相关元信息，并和多种指标相结合；
* [X] 可集成 `prometheus` 和 `Grafana`，作为监控可视化和预警平台；
* [X] 可自定义运行时安全预警规则, 并通过 prometheus 等实现监控告警; 
* [X] 可以自动收集进程系统调用行为并通过 seccomp 进行限制；
* [ ] 可通过 `graphql` 在远程发起 http 请求并执行监控工具，将产生的数据进行聚合后返回，用户可自定义运行时扩展插件进行在线数据分析；可外接时序数据库，如 `InfluxDB` 等，作为可选的信息持久化存储和数据分析方案；

除了收集容器中的一般系统运行时内核指标，例如系统调用、网络连接、文件访问、进程执行等，我们在探索实现过程中还发现目前对于 `lua` 和 `nginx` 相关用户态 `profile` 工具和指标可观测性开源工具存在一定的空白，但又有相当大的潜在需求；因此我们还计划添加一系列基于 uprobe 的用户态 `nginx/lua` 追踪器，作为可选的扩展方案；（这部分需求来自中科院开源之夏， APISIX 社区的选题）

和过去常用的 `BCC` 不同，`Eunomia` 基于 `Libbpf` + BPF CO-RE（一次编译，到处运行）开发。Libbpf 作为 BPF 程序加载器，接管了重定向、加载、验证等功能，BPF 程序开发者只需要关注 BPF 程序的正确性和性能即可。这种方式将开销降到了最低，且去除了庞大的依赖关系，使得整体开发流程更加顺畅。目前，我们已经发布了 `pre-release` 的版本，其中部分功能已经可以试用，只需下载二进制文件即可运行，


### 2.2. Tutorial

`Eunomia` 的 `ebpf` 追踪器部分是从 `libbpf-tools` 中得到了部分灵感，但是目前关于 ebpf 的资料还相对零散且过时，这也导致了我们在前期的开发过程中走了不少的弯路。因此, 我们也提供了一系列教程，以及丰富的参考资料，旨在降低新手学习eBPF技术的门槛，试图通过大量的例程解释、丰富对 `eBPF、libbpf、bcc` 等内核技术和容器相关原理的认知，让后来者能更深入地参与到 ebpf 的技术开发中来。另外，`Eunomia` 也可以被单独编译为 C++ 二进制库进行分发，可以很方便地添加自定义 libbpf检查器，或者直接利用已有的功能来对 syscall 等指标进行监测，教程中也会提供一部分 `EUNOMIA` 扩展开发接口教程。

> 教程目前还在完善中。

1. [eBPF介绍](doc/tutorial/0_eBPF介绍.md)
2. [eBPF开发工具介绍: BCC/Libbpf，以及其他](doc/tutorial/1_eBPF开发工具介绍.md)
3. [基于libbpf的内核级别跟踪和监控: syscall, process, files 和其他](doc/tutorial/2_基于libbpf的内核级别跟踪和监控.md)
4. [基于uprobe的用户态nginx相关指标监控](doc/tutorial/3_基于uprobe的用户态nginx相关指标监控.md)
5. [seccomp权限控制](doc/tutorial/4_seccomp权限控制.md)
6. [上手Eunomia: 基于Eunomia捕捉内核事件](doc/tutorial/x_基于Eunomia捕捉内核事件.md)

## 3. 比赛题目分析和相关资料调研

### 3.1. 题目描述

容器是一种应用层抽象，用于将代码和依赖资源打包在一起。多个容器可以在同一台机器上运行，共享操作系统内核。这使得容器的隔离性相对较弱，带来安全上的风险，最严重时会导致容器逃逸，严重影响底层基础设施的保密性、完整性和可用性。

eBPF 是一个通用执行引擎，能够高效地安全地执行基于系统事件的特定代码，可基于此开发性能分析工具**、网络数据包过滤、系统调用过滤，**系统观测和分析等诸多场景。eBPF可以由hook机制在系统调用被使用时触发，也可以通过kprobe或uprobe将eBPF程序附在内核/用户程序的任何地方。

这些机制让eBPF的跟踪技术可以有效地感知容器的各项行为，包括但不限于：

- 容器对文件的访问
- 容器对系统的调用
- 容器之间的互访

请基于eBPF技术开发一个监控工具，该工具可以监控容器的行为，并生成报表（如json文件）将各个容器的行为分别记录下来以供分析。

- **第一题：行为感知**

  编写eBPF程序，感知容器的各项行为。
- **第二题：信息存储**

  在第一题的基础上，令工具可以将采集到的数据以特定的格式保存在本地。
- **第三题：权限推荐（可选）**

  Seccomp是Linux内核的特性，开发者可以通过seccomp限制容器的行为。capabilities则将进程作为root的权限分成了各项更小的权限，方便			调控。这两个特性都有助于保障容器安全，但是因为业务执行的逻辑差异，准确配置权限最小集非常困难。请利用上面开发的监控工具，分析业务容器的行为记录报表，然后基于报表自动推荐精准的权限配置最小集。
### 3.2. 赛题分析

TODO

### 3.3. 相关资料调研

#### 3.3.1. ebpf

#### 3.3.2. ebpf 开发工具技术选型

#### 3.3.3. 容器可观测性

#### 3.3.4. 信息可视化展示

#### 3.3.5. 容器运行时安全

## 4. 系统框架设计

### 4.1. 系统设计

### 4.2. 模块设计

### 4.3. 功能设计

### 4.4. ebpf 主要观测点

### 4.5. ebpf 可观测信息设计

### 4.6. 重要数据结构设计

### 4.7. 安全规则设计

## 5. 开发计划

阶段一：学习ebpf相关技术栈（3.10~4.2）

* [X] 入门ebpf技术栈
* [X] 调研、学习 `bcc`
* [X] 调研、学习 `libbpf` 、`libbpf-bootstrap`
* [X] 调研、学习 `seccomp`
* [X] 输出调研文档

阶段二：项目设计（4.3~4.10）

* [X] 与mentor讨论项目需求、并设计功能模块
* [X] 输出系统设计文档
* [X] 输出模块设计文档

阶段三：开发迭代（4.10~6.1）

* [X] 实现进程信息监控（pid、ppid等）
* [X] 实现系统调用信息监控
* [X] 实现进程间通信监控
* [X] 实现tcp（ipv4、ipv6）通信监控
* [X] 实现监控信息存储功能（csv或json格式）
* [X] 完成了系统的原型验证功能
* [X] 基于上述功能，实现命令行调用，完成版本v0.1
* [X] 输出开发v0.1日志文档
* [X] 实现进程id与容器id映射，进程信息过滤
* [X] 添加“seccomp”功能
* [x] 基于上述新增功能，迭代版本v0.2
* [X] 输出开发v0.2日志文档
* [x] 添加可视化模块: prometheus and grafana
* [X] add more tools from libbpf-tools
* [X] 基于上述新增功能，迭代版本v0.3
* [X] 输出开发v0.3日志文档
* [ ] 后续更新迭代

阶段四：开发测试（6.2~6.16）

* [ ] graphql for extentions
* [ ] lsm support
* [ ] add more rules
* [ ] 设计测试场景（分别针对基础功能、权限控制、安全逃逸场景）
* [X] 搭建测试环境
* [ ] 测试-开发
* [ ] 输出测试文档

阶段五：项目文档完善（6.17~7.1）

* [ ] 完善开发文档
* [ ] 完善教程文档
* [ ] 完善labs

## 6. 比赛过程中的重要进展


## 7. 系统测试情况

### 7.1. 命令行测试情况


### 7.2. 容器测试情况


### 7.3. 信息可视化测试情况： prometheus and grafana


### 7.4. CI/持续集成

## 8. 遇到的主要问题和解决方法

### 8.1. 如何设计 ebpf 挂载点

### 8.2. 如何进行内核态数据过滤和数据综合

### 8.3. 如何定位容器元信息

### 8.4. 如何设计支持可扩展性的数据结构

## 9. 分工和协作



## 10. 提交仓库目录和文件描述


### 10.1. 项目仓库


### 10.2. 文件描述


## 11. 比赛收获

## 12. 附录

### 12.1. Prometheus 观测指标


### 12.2. 命令行工具帮助信息
